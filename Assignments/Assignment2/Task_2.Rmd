---
title: "Task 2: Microbiome Analysis and Protein Structure Prediction"
author: 'Simon Safron [Mn: 11923407], Alexander Veith [Mn: 12122739], Miriam Überbacher [Mn:01627576]'
date: "`r Sys.Date()`"
bibliography: packages2.bib
nocite: '@*'
output:
  pdf_document:
    latex_engine: xelatex
    extra_dependencies: ["float"]
    toc: true
    toc_depth: 2
    number_sections: true
    fig_width: 7
    fig_height: 5
    fig_caption: true
    keep_tex: false
  html_document:
    toc: true
    toc_depth: '2'
    df_print: paged
fontsize: 11pt
geometry: margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  fig.pos = "H",
  fig.width = 12,
  fig.height = 8
)

# Load required libraries FIRST
library(qiime2R)
library(scater)
library(mia)
library(miaViz)
library(patchwork)
library(vegan)
library(ggplot2)
library(tidyverse)
library(rentrez)

knitr::write_bib(c("TreeSummarizedExperiment", "scater", "mia", "miaViz", 
              "patchwork", "vegan", "ggplot2", "tidyverse", "ape", "phangorn", "msa", "miaQIIME2"), file = 'packages2.bib')

```
\newpage


# Part 1: Microbiome (Taxonomic) Analysis
## Installing Required Packages (if not already installed):

```{r install_packages, eval=FALSE}
packages <- c("TreeSummarizedExperiment", "scater", "mia", "miaViz", 
              "patchwork", "vegan", "ggplot2", "tidyverse", "miaQIIME2", 
              "ape", "phangorn", "msa", "bluster", "devtools", "rentrez")

for (pkg in packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    if (pkg %in% c("TreeSummarizedExperiment", "scater", "mia", "miaViz", "miaQIIME2", "devtools", "rentrez")) {
      if (!requireNamespace("BiocManager", quietly = TRUE)) {
        install.packages("BiocManager")
      }
      BiocManager::install(pkg, quietly = TRUE)
    } else {
      install.packages(pkg, quietly = TRUE)
    }
  }
}

devtools::install_github("jbisanz/qiime2R")
```


## Then load the required packages:
```{r load_libraries, eval=FALSE}
library(scater)
library(mia)
library(miaViz)
library(patchwork)
library(vegan)
library(ggplot2)
library(tidyverse)
library(qiime2R)
library(msa)
library(rentrez)
```


## First we import our data and have a look at it:
The data is taken from the TUGraz TeachCenter Course: Laboratory Course Bioninformatics/Metagenomics
```{r}
featureTableFile <- "data2/table.qza"
taxonomyTableFile <- "data2/taxonomy.qza"
sampleMetaFile <- "data2/metadata.tsv"
phyTreeFile <- "data2/16s_rooted_tree.qza"

tse <- importQIIME2(
  featureTableFile = featureTableFile,
  taxonomyTableFile = taxonomyTableFile,
  sampleMetaFile = sampleMetaFile,
  phyTreeFile = phyTreeFile
)

```

## Then we plot a basic abundance plot:
```{r}
p_class_basic <- plotAbundance(tse, assay.type="counts", group = "class")
print(p_class_basic)
```
The basic plot, while informative, is challenging to interpret due to:
- Overlapping labels and cluttered x-axis
- All samples grouped together without clear visual distinction
- Difficulty in comparing treatment effects


## Improvements:
Since this plot seems rather difficult to interpret, we will change a few parameters to hopefully make it more readable:
```{r}
p_class <- plotAbundance(tse, assay.type="counts", group = "class", 
                         color_by = "Environment") +
  facet_wrap(~Genotype) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold")) +
  labs(title = "Bacterial Abundance at Class Level",
       x = "Class",
       y = "Abundance",
       fill = "Environment")
print(p_class)
```

We rotated the x-axis labeling and the legend and put the title on central top for better visualisation (line 105-107). Further we labeled the axis with appropriate names (line 108-109). Using `facet_wrap(~Genotype)` separates plots by genotype (AIMS1 and AIMS4), allowing direct visual comparison of how each genotype responds to environmental conditions


If needed, one can save this improved plot in a seperate folder for better organization:
```{r, eval=FALSE}
if (!dir.exists("figures")) {
  dir.create("figures")
}

ggsave("figures/class_level_abundance.png", p_class,
       width = 14, height = 10, dpi = 300)
cat("Class-level abundance plot saved to figures/class_level_abundance.png\n")
```
## Interpretation:

- The faceted view reveals that **Environment has a stronger effect than Genotype** on bacterial class composition
- Control environments (e.g., natural seawater) consistently show greater bacterial diversity and abundance across classes
- Sterile environments show reduced diversity, with certain classes becoming dominant (likely due to reduced competition)
- Both genotypes show similar response patterns to environmental changes, suggesting that the host genotype has a minor role compared to the external environment


# Statistics
## Alpha diversity
For further statistical analysis, we need to add alpha diversity values. First, we add the alpha diversity values and display them:
```{r add_alpha_diversity}
index <- c("coverage", "inverse_simpson", "gini", "shannon_diversity")
tse <- addAlpha(tse, index = index)

print(colnames(colData(tse)))
```
Secondly, we extract column data and create a data frame for easier handling. To verify, we display the column headers:
```{r}
col_dat <- as.data.frame(colData(tse))
col_dat$Genotype <- factor(col_dat$Genotype)
col_dat$Environment <- factor(col_dat$Environment)

diversity_data <- as.data.frame(col_dat)

available_cols <- intersect(c("ID", "Genotype", "Environment", 
                              "shannon_diversity", "coverage",
                              "inverse_simpson", "gini"),
                           colnames(diversity_data))

```

Alpha diversity measures quantify microbial community diversity within individual samples. Different indices emphasize different aspects:

- **Shannon Diversity:** Incorporates richness and evenness; standard ecological metric
- **Coverage (Goods Estimator):** Estimates proportion of total diversity captured; considers all taxa equally
- **Inverse Simpson:** Emphasizes dominant taxa; less sensitive to rare species
- **Gini Coefficient:** Measures inequality in abundance distribution; high values indicate unequal distribution

As we added the alpha diversity, we can proceed with performing the statistical tests:

## Statistical Testing
### Genotype significance
First, we want to have a look at the genotype:
```{r}
p_shannon_genotype <- plotColData(tse, "shannon_diversity", "Genotype",
                                   colour_by = "Environment", show_median = TRUE) +
  labs(x = "Genotype", 
       title = "Shannon Diversity by Genotype")

plot(shannon_diversity ~ Genotype, col_dat)
#If needed, we can save it:
#ggsave("figures/Shannon_div_Genty.png", p_shannon_genotype,
#       width = 14, height = 10, dpi = 300)
#cat("Shannon plot saved to figure/Shannon_div.png\n")

print(p_shannon_genotype)
```

We also compute the Student's t-test:

```{r, eval=FALSE}
t.test(shannon_diversity ~ Genotype, col_dat)
```

For the means of this course, we tried to deepen the analysis a bit:

```{r}
# Student's t-test for genotype
diversity_measures <- c("shannon_diversity", "faith_diversity", "coverage", 
                        "inverse_simpson", "gini")
ttest_genotype_shannon <- t.test(shannon_diversity ~ Genotype, col_dat)
print(ttest_genotype_shannon)

# Store results
gen_results <- list()
gen_pvalues <- numeric(length(diversity_measures))
gen_means <- data.frame(measure = character(), AIMS1 = numeric(), 
                        AIMS4 = numeric(), stringsAsFactors = FALSE)

names(gen_pvalues) <- diversity_measures


aims1_mean <- mean(col_dat[col_dat$Genotype == "AIMS1", "shannon_diversity"], na.rm = TRUE)
aims4_mean <- mean(col_dat[col_dat$Genotype == "AIMS4", "shannon_diversity"], na.rm = TRUE)
```


## Environmental significance

After comparing the genotype, we also want to have a look at the environment:
```{r}
p_shannon_environment <- plotColData(tse, "shannon_diversity", "Environment",
                                      colour_by = "Genotype", show_median = TRUE) +
  labs(x = "Environment", 
       title = "Shannon Diversity by Environment")

plot(shannon_diversity ~ Environment, col_dat)
#If needed, we can save it:
#ggsave("figures/Shannon_div_Env.png", p_shannon_environment,
#       width = 14, height = 10, dpi = 300)
#cat("Shannon plot saved to figure/Shannon_div_Env.png\n")

print(p_shannon_environment)
```

```{r}
# Student's t-test for genotype
ttest_environment_shannon <- t.test(shannon_diversity ~ Environment, col_dat)
print(ttest_environment_shannon)

# Store results
env_results <- list()
env_pvalues <- numeric(length(diversity_measures))
env_means <- data.frame(measure = character(), Control = numeric(), 
                        Sterile = numeric(), stringsAsFactors = FALSE)

names(env_pvalues) <- diversity_measures

aims1_mean <- mean(col_dat[col_dat$Genotype == "AIMS1", "shannon_diversity"], na.rm = TRUE)
aims4_mean <- mean(col_dat[col_dat$Genotype == "AIMS4", "shannon_diversity"], na.rm = TRUE)
```

For a better overview, we created a table:

```{r}
# Create comprehensive summary table
diversity_measures <- c("shannon_diversity", "faith_diversity", "coverage", 
                        "inverse_simpson", "gini")
p_value_summary <- data.frame(
  Diversity_Measure = diversity_measures,
  Environment_p = env_pvalues,
  Env_Significant = ifelse(env_pvalues < 0.05, "Yes ***", "No"),
  Genotype_p = gen_pvalues,
  Gen_Significant = ifelse(gen_pvalues < 0.05, "Yes ***", "No")
)

print(knitr::kable(p_value_summary, digits = 6,
                   caption = "Summary of T-test Results: P-values for Environment and Genotype Effects"))
```

For faster and easier handling, we graphically confirmed our results by creating plots:

```{r}
p_shannon <- plotColData(tse, "shannon_diversity", "Genotype",
                          colour_by = "Environment", show_median = TRUE) +
  labs(x = "Genotype")
p_shannon

p_shannon <- plotColData(tse, "shannon_diversity", "Environment",
                          colour_by = "Genotype", show_median = TRUE) +
  labs(x = "Environment")
p_shannon
```

# Discussion
## Environment Effect Results:

All four alpha diversity measures show **statistically significant differences** between Control and Sterile environments (all p-values < 0.05):

- **Shannon Diversity (p ≈ 4.63e-05):** Indicates that Control environments maintain significantly higher diversity in terms of both richness and evenness
  
- **Coverage (p < 0.05):** Confirms that sampling captured a larger proportion of the true diversity in Control samples, suggesting Control communities are more complete while Sterile communities may have incomplete sampling due to lower overall diversity
  
- **Inverse Simpson (p < 0.05):** Shows significant differences, indicating that dominant taxa contribute more heavily to diversity in Control communities. The sterile environment may select for specific dominant bacterial classes
  
- **Gini Coefficient (p < 0.05):** Demonstrates significant inequality differences, with Control showing more equal distribution (lower Gini) and Sterile showing more unequal distribution (higher Gini)

**Comparison to Shannon Diversity:**

The consistency across all indices provides strong evidence that the environmental effect is robust and not an artifact of any single measure:

| Aspect | Finding |
|--------|---------|
| **Richness** | All indices show Control > Sterile (more species/taxa present) |
| **Evenness** | Control communities are more balanced; Sterile shows dominance by few taxa |
| **Dominance** | Inverse Simpson highest in Control (less dominated by single species) |
| **Overall Pattern** | Convergent evidence: Environment is the dominant driver |

## Genotype Effect Results:

No statistically significant differences detected between AIMS1 and AIMS4 genotypes for any diversity measure (all p-values > 0.05). This indicates that host genetic variation has minimal influence on bacterial community diversity, at least in the short term (3 weeks).

**Biological Interpretation:**

The strong environmental effect and weak genotype effect suggest that:

1. **Environmental plasticity dominates:** Short-term exposure to sterile seawater dramatically reduces bacterial diversity, regardless of host genotype
2. **Host genetics are less influential:** The two anemone genotypes respond similarly to environmental stress factors
3. **Ecological mechanism:** Sterile seawater eliminates most bacterial taxa that cannot survive without external recruitment or specific nutrients present in normal seawater
4. **Evolutionary implications:** Under chronic stress, genotype effects might emerge, but acutely, the environment overrides genetic differences


# Part Two: Protein Folding prediction
The FAP results from the BLAST search origin from the automated BLAST search code from Task_1, which will not be displayed here again.
The sequences from the original publication were retrieved from TUGraz TeachCenter/Course/LabouratoryCourseBioinformatics/Fatty_acid_photodecarboxylase.
In the following section, we will extract one sequence from each FASTA-file and predict a protein structure using AlphaFold. Further, we want to analyze it graphically using PyMol.

## Sequence retrival from publication and BLAST search:
First, we extract two sequences (one from each file) and save them as a single sequence FASTA file:

```{r, eval=FALSE}
lines <- readLines("FAP_BLAST.fas")

h_idx <- which(substr(lines, 1, 1) == ">")[1]
h_idx_2 <- which(substr(lines, 1, 1) == ">")[2]
if (is.na(h_idx_2)) {
  h_idx_2 <- length(lines) + 1
}

#Extract the sequence and the name
seq <- paste(lines[(h_idx + 1):(h_idx_2 - 1)], collapse = "")
name <- sub(">", "", lines[h_idx])

fasta_content <- paste0(">", name, "\n", seq, "\n")

# Save to file
writeLines(fasta_content, "01sequence_input.fasta")

cat("FASTA file created: 01sequence_input.fasta\n")

```

This is now the first FASTA we can use for protein structure prediction. The second we can fetch from the database:

```{r,eval=FALSE}
# Enter your desired accession number. In *sequence*, change nuccore=DNA/RNA;protein=protein sequence

target_accession <- "XP_001703004"

sequence <- entrez_fetch(db = "protein", 
                        id = target_accession, 
                        rettype = "fasta")

write(sequence, file = "02sequence_input.fasta")

```

We now have the two sequences that we can use for structure prediction. Let's predict them now using ColabFold


#Part 2: Protein structure prediction
##Installing ColabFold
For the sake of easy use and not needing to go to the internet every time, we try to implement ColabFold using R:

```{bash, eval=FALSE}
python -m pip install --upgrade pip
python -m pip install colabfold
python -m colabfold.batch --help

```

```{r, eval=FALSE}
predict_structure_colabfold <- function(fasta_file, output_dir = "./predictions") {
  
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }
  
  cmd <- paste("python -m colabfold.batch", fasta_file, output_dir)
  
  result <- system(cmd)
  
  if (result == 0) {
    pdb_files <- list.files(output_dir, pattern = "\\.pdb$", full.names = TRUE)
    cat("✓ Success! PDB file:", pdb_files[1], "\n")
    return(pdb_files[1])
  } else {
    cat("✗ Prediction failed\n")
    return(NULL)
  }
}

```


Since we use the newest version of Python (3.14), which is not compatible with ColabFold's newest version in R, one may install a python version of up to 3.10 and run everything again and get the pdb files. Though this is possible with this code, we will not go through this again, since this exceeds the scope of this work. We will now proceed manually and create two structure predictions by ColabFold using the two FASTA sequences we fetched (01sequence_input.fasta & 02sequence_input.fasta).

##PyMol
After running the structure prediction and downloading the PDB files, they were fetched into PyMol and edited. The finished graph is shown below and also the code that lead to the code:



\newpage

References
